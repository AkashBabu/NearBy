<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for NearBy\server.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">NearBy/</a> server.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">62.26% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>33/53</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">28.57% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>4/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/3</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">63.46% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>33/52</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span></td><td class="text"><pre class="prettyprint lang-js">require('./config/init.globals'); // Initialises all the global variables
&nbsp;
var express = require('express')
var middlewares = require('./lib/middlewares') // Middlewares for sessions
var cookieParser = require('cookie-parser')
&nbsp;
var path = require('path')
var bodyParser = require("body-parser")
&nbsp;
var logger = require('morgan')
&nbsp;
var port = config.app.ports[config.env]
var whiteList = ['/portal/login']
&nbsp;
var app = express();
&nbsp;
app.disable("x-powered-by");
app.set("views", path.join(__dirname, "views"))
app.set("view engine", "ejs")
app.engine('html', require('ejs').renderFile)
&nbsp;
app.use("/dist", express.static(path.join(__dirname, "dist")))
app.use("/public", express.static(path.join(__dirname, "public")))
&nbsp;
&nbsp;
// File logging for PROD and console logging for TEST&amp;DEV
var loggerFormat = ':remote-addr - [:date[clf]] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent" :response-time ms'
<span class="missing-if-branch" title="else path not taken" >E</span>if (config.env == "DEV" || config.env == 'TEST') {
    app.use(logger(loggerFormat))
} else {
&nbsp;
<span class="cstat-no" title="statement not covered" >    var fs = require('fs')</span>
<span class="cstat-no" title="statement not covered" >    var rotateFileStream = require("rotating-file-stream")</span>
<span class="cstat-no" title="statement not covered" >    var apiLogDir = path.join(__dirname, "api-logs")</span>
<span class="cstat-no" title="statement not covered" >    fs.existsSync(apiLogDir) || fs.mkdirSync(apiLogDir)</span>
<span class="cstat-no" title="statement not covered" >    var accessLogger = rotateFileStream('access.log', {</span>
        size: '1M',
        interval: '1m',
        path: apiLogDir,
        compress: 'gzip'
    })
&nbsp;
<span class="cstat-no" title="statement not covered" >    app.use(logger(loggerFormat, { stream: accessLogger }))</span>
}
&nbsp;
// Use session only after serving static files
app.use(cookieParser(config.app.token.cookie.secret))
app.use(bodyParser.json())
app.use(bodyParser.urlencoded({ extended: false }))
&nbsp;
&nbsp;
// app.use(/^\/(.*)/, function(req, res, next) {
//         testLog.log('path:', req.path)
//         testLog.log('path:', req.params)
//         next();
//     })
// Middlewares for Creating and validating JWT Tokens
app.post('/login', middlewares.loginUser())
app.post('/register', middlewares.registerUser())
app.get("/logout", middlewares.logout())
app.use(<span class="fstat-no" title="function not covered" >function(req, res, next) {</span>
<span class="cstat-no" title="statement not covered" >    if (whiteList.indexOf(req.path) &gt; -1) {</span>
<span class="cstat-no" title="statement not covered" >        next()</span>
    } else <span class="cstat-no" title="statement not covered" >if (req.urlRedirect) {</span>
<span class="cstat-no" title="statement not covered" >        req.urlRedirect = false;</span>
<span class="cstat-no" title="statement not covered" >        next()</span>
    } else {
<span class="cstat-no" title="statement not covered" >        middlewares.validateToken(req, res, next)</span>
    }
})
&nbsp;
app.use("/api", require("./routers/api"))
app.use("/portal", require("./routers/portal"))
&nbsp;
// Not Found
app.use(<span class="fstat-no" title="function not covered" >function(req, res) {</span>
    // res.status(404).send("Page Not Found")
<span class="cstat-no" title="statement not covered" >    res.redirect("/portal/index")</span>
})
&nbsp;
// Error Handler
app.use(<span class="fstat-no" title="function not covered" >function(err, req, res, next) {</span>
<span class="cstat-no" title="statement not covered" >    errLog.error("SERVER_ERR:", err)</span>
<span class="cstat-no" title="statement not covered" >    res.status(500).send("Internal Server Error")</span>
})
&nbsp;
// Start Server
app.listen(port, (err) =&gt; {
<span class="cstat-no" title="statement not covered" >    if (err) <span class="cstat-no" title="statement not covered" >errLog.error("FAILED TO START SERVER:", err)</span></span>
    else <span class="cstat-no" title="statement not covered" >genLog.log('NearBy Server Running on Port:', port);</span>
})
&nbsp;
<span class="missing-if-branch" title="if path not taken" >I</span>if (config.env == "PROD") {
<span class="cstat-no" title="statement not covered" >    process.on("uncaughtException", (err) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >        errLog.error('Uncaught Exception:', err)</span>
    })
}
&nbsp;
module.exports = app</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun May 21 2017 15:10:26 GMT+0530 (India Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
